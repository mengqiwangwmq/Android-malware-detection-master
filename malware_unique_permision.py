from androguard.core.bytecodes.dvm import DalvikVMFormat
from androguard.core.analysis.analysis import Analysis
from androguard.decompiler.decompiler import DecompilerDAD
from androguard.core.bytecodes.apk import APK
from androguard.core.analysis import analysis
from androguard.core.bytecodes import dvm
import math
import hashlib
import glob, os

#To extract permission of APK file from Androguard
def extract_features(file_path):
    #result = []

    a = APK(file_path)
    #print(a.get_permissions())
    #d = DalvikVMFormat(a.get_dex())
    #dx = Analysis(d)
    #vm = dvm.DalvikVMFormat(a.get_dex())
    #vmx = analysis.Analysis(vm)
    #d.set_Analysis(dx)
    #d.set_decompiler(DecompilerDAD(d, dx))
    '''
    try:
        a = APK(file_path)
        print(a.get_permissions())
        d = DalvikVMFormat(a.get_dex())
        dx = Analysis(d)
        vm = dvm.DalvikVMFormat(a.get_dex())
        vmx = analysis.uAnalysis(vm)
        d.set_Analysis(dx)
        d.set_decompiler(DecompilerDAD(d, dx))
    except:
        return None
'''

    return a.get_permissions()

#Extracting permission from apk in a malware folder and removing redundant permission
if __name__ == "__main__":
    os.chdir("drebin-0")  #Folder path of Beningn apk
    max_case = 208    #Total number of apk in a folder
    i = 1
    permission_list = []
    for file in glob.glob("*"):
        if i<=max_case:
            permissions = extract_features(file)

            if permissions is None:
                print("null")
                pass
            else:
                for permission in permissions:
                    if permission not in permission_list:
                        permission_list.append(permission)
                        print(permission)
            print ("Progress: ",str((float(i)/float(max_case))*100.00),"%" )  #it will show how much file it process
            
        i+=1

   #writing the permission in a txt file

    op = open("unique_malware_permission.txt","w+")
    for permission in permission_list:
        op.write(str(permission))
        op.write('\n')

